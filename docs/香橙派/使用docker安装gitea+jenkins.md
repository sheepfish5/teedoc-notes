# ä½¿ç”¨dockerå®‰è£…gitea+jenkins

å‚è€ƒï¼š[Gitea ä¸ Jenkins çš„é›†æˆå®è·µï¼Œæ‰“é€ ä½ çš„ä¸“å± CI/CD ç³»ç»Ÿ](https://www.cnblogs.com/Gitea/p/jenkins.html)

## æ³¨æ„

### 1. Jenkinsçš„ç‰ˆæœ¬é—®é¢˜

Jenkinsä¸èƒ½åƒlinuxçš„åŒ…ç®¡ç†å™¨é‚£æ ·è‡ªåŠ¨å¤„ç†å„ç§ç‰ˆæœ¬å†²çªï¼Œå› æ­¤ç¬¬ä¸€æ¬¡å®‰è£…æ’ä»¶æ—¶ä¸å‡ºæ„å¤–ä¸€å®šä¼šå¤±è´¥ã€‚ä½†æ‰‹åŠ¨å¤„ç†å†²çªï¼ˆå†å®˜ç½‘ä¸Šä¾æ¬¡ä¸‹è½½é€‚åˆå½“å‰Jenkinsç‰ˆæœ¬çš„æ’ä»¶ï¼‰å®åœ¨æ˜¯è¿‡äºéº»çƒ¦ï¼Œå› æ­¤é€‰æ‹©æ‰‹åŠ¨å°†Jenkinså‡è‡³æœ€æ–°ç‰ˆï¼Œè¿™æ ·ä¸€èˆ¬èƒ½ç›´æ¥æ»¡è¶³æ‰€æœ‰æ’ä»¶å¯¹Jenkinsçš„ç‰ˆæœ¬è¦æ±‚ã€‚å…·ä½“åšæ³•æ˜¯ä»å®˜ç½‘ä¸‹è½½Jenkinsçš„æœ€æ–°ç‰ˆwaråŒ…ï¼Œè¿è¡Œdockerå®¹å™¨ï¼Œå°†ä¸‹è½½çš„waråŒ…æ›¿æ¢æ‰å®¹å™¨ä¸­çš„`/usr/share/jenkins/jenkins.war`ï¼Œç„¶åå†é‡å¯å®¹å™¨å³å¯ã€‚é‡å¯ä¹‹åï¼Œæ‰€æœ‰æ’ä»¶è‡ªåŠ¨å®‰è£…æˆåŠŸã€‚

> æ›¿æ¢æœ€æ–°ç‰ˆwaråŒ…å‚è€ƒï¼š[Dockeréƒ¨ç½²çš„Jenkinså¦‚ä½•æ›´æ–°ç‰ˆæœ¬å‘¢](https://blog.csdn.net/tomonkey/article/details/106942162)

### 2. Jenkinsç‰ˆæœ¬ç»ˆæè§£å†³æ–¹æ³•

å…ˆä¸ŠDocker Hubæœjenkinsï¼Œç„¶åä½¿ç”¨ä»–ä»¬æœ€æ–°ç‰ˆæœ¬çš„tagï¼Œæ³¨æ„ä¸è¦ç”¨é»˜è®¤çš„`latest`ï¼Œé‚£ä¸ªä¸æ˜¯æœ€æ–°ç‰ˆã€‚æ¯”å¦‚ç°åœ¨çš„æœ€æ–°ç‰ˆæ˜¯`jenkins/jenkins:2.414`ã€‚

ä¸è¦å†æ‰‹åŠ¨æ›¿æ¢äº†ï¼Œé‚£æ ·å¤ªéº»çƒ¦äº†ã€‚

### 3. giteaçš„webhookæ— æ³•è§¦å‘

è¦åœ¨jenkinsçš„ç³»ç»Ÿé…ç½®é‡Œä¸ºGitea Serverå¢åŠ URLåˆ«åï¼Œå…·ä½“å¯ä»¥ç‚¹Alias URLæ—è¾¹çš„é—®å·ã€‚

> å‚è€ƒï¼š[stackoverflow](https://stackoverflow.com/a/68432979/21743075)

~~ä½†å³ä½¿æ˜¯ä½¿ç”¨äº†è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä¹Ÿä¸èƒ½è®©webhookç¨³å®šè§¦å‘ã€‚è‡³å°‘æ˜¯æˆ‘ä½¿ç”¨Gitea Webhookæä¾›çš„å‡äº‹ä»¶æ— æ³•è§¦å‘ã€‚~~çœ‹èµ·æ¥ä¸æ˜¯jenkinsçš„é—®é¢˜ï¼Œå‡äº‹ä»¶çš„ç¡®æ— æ³•è§¦å‘ï¼Œä½†æ¯æ¬¡æäº¤éƒ½èƒ½æ­£å¸¸è§¦å‘æ„å»ºï¼Œè¿™æ ·å°±ç®—æ˜¯è§£å†³äº†é—®é¢˜ã€‚

### 4. giteaçš„ç‰ˆæœ¬é—®é¢˜

å’Œjenkinsä¸€æ ·ï¼Œé»˜è®¤çš„`latest`æ ‡ç­¾å¹¶ä¸æ˜¯æœ€æ–°ç‰ˆï¼Œä¹Ÿå¾—ä¸ŠDocker Hubæ‰‹åŠ¨æœgiteaå¹¶ç¡®å®šæœ€æ–°ç‰ˆã€‚æ¯”å¦‚ç›®å‰çš„æœ€æ–°ç‰ˆæ˜¯`gitea/gitea:1.20-nightly`ã€‚

å¦å¤–é™„ä¸Šgiteaæ™®é€šç‰ˆå’Œnightlyç‰ˆçš„åŒºåˆ«ï¼š

> ä½ å¥½ï¼Œè¿™æ˜¯Bingã€‚æˆ‘å¯ä»¥å¸®ä½ æ‰¾åˆ°ä¸€äº›å…³äºgiteaæ™®é€šç‰ˆå’Œgitea nightlyçš„åŒºåˆ«çš„ä¿¡æ¯ã€‚ğŸ˜Š
> æ ¹æ®æˆ‘çš„æœç´¢ç»“æœï¼Œgiteaæ™®é€šç‰ˆæ˜¯æŒ‡giteaçš„æ­£å¼å‘å¸ƒç‰ˆæœ¬ï¼Œå®ƒç»è¿‡äº†å……åˆ†çš„æµ‹è¯•å’ŒéªŒè¯ï¼Œä¿è¯äº†ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚gitea nightlyæ˜¯æŒ‡giteaçš„æ¯æ—¥æ„å»ºç‰ˆæœ¬ï¼Œå®ƒåŒ…å«äº†æœ€æ–°çš„å¼€å‘è¿›å±•å’ŒåŠŸèƒ½ï¼Œä½†å¯èƒ½å­˜åœ¨ä¸€äº›é”™è¯¯å’Œé—®é¢˜ã€‚
> å¦‚æœä½ æƒ³ä½¿ç”¨giteaçš„æœ€æ–°åŠŸèƒ½å’Œç‰¹æ€§ï¼Œä½ å¯ä»¥é€‰æ‹©gitea nightlyï¼Œä½†ä½ éœ€è¦æ³¨æ„å¤‡ä»½ä½ çš„æ•°æ®å’Œé…ç½®ï¼Œå¹¶ä¸”åŠæ—¶åé¦ˆä»»ä½•é—®é¢˜ã€‚å¦‚æœä½ æƒ³ä½¿ç”¨giteaçš„ç¨³å®šç‰ˆæœ¬ï¼Œä½ å¯ä»¥é€‰æ‹©giteaæ™®é€šç‰ˆï¼Œä½†ä½ å¯èƒ½æ— æ³•äº«å—åˆ°ä¸€äº›æ–°çš„æ”¹è¿›å’Œä¼˜åŒ–ã€‚
> ä½ å¯ä»¥åœ¨è¿™é‡Œä¸‹è½½giteaçš„ä¸åŒç‰ˆæœ¬ï¼š<https://dl.gitea.io/gitea/>
> å¸Œæœ›è¿™äº›ä¿¡æ¯å¯¹ä½ æœ‰å¸®åŠ©ã€‚å¦‚æœä½ è¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œæ¬¢è¿ç»§ç»­æé—®ã€‚ğŸ˜Š

### 5. æ–°ç‰ˆgiteaçš„WebhookæŠ¥é”™ webhook.ALLOWED_HOST_LIST

ä½¿ç”¨æ–°ç‰ˆï¼ˆ1.20ï¼‰giteaï¼Œåœ¨æµ‹è¯•åˆ°jenkinsçš„webhookæ—¶ï¼Œæ— æ³•æ¨é€ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š

~~~text
Delivery: Post "http://jenkins:8080/gitea-webhook/post": dial tcp 172.26.0.2:8080: webhook can only call allowed HTTP servers (check your webhook.ALLOWED_HOST_LIST setting), deny 'jenkins(172.26.0.2:8080)'
~~~

åŸå› æ˜¯giteaæ— æ³•å‘é€postè¯·æ±‚ï¼Œå› ä¸ºæ–°ç‰ˆgiteaé»˜è®¤ç¦ç”¨äº†webhookï¼ˆï¼Ÿï¼Ÿï¼Ÿwhyï¼Ÿï¼Ÿï¼Ÿï¼‰ï¼Œåœ¨`/data/gitea/conf/app.ini`ä¸­åŠ ä¸Šï¼š

~~~text
[webhook]
ALLOWED_HOST_LIST = *
~~~

ä¹‹åé‡å¯å®¹å™¨ï¼ˆ`docker container restart gitea`ï¼‰å³å¯ã€‚

å‚è€ƒï¼š[WebhookæŠ¥é”™ webhook.ALLOWED_HOST_LIST](https://discourse.gitea.io/t/webhook-webhook-allowed-host-list-setting/4655)
